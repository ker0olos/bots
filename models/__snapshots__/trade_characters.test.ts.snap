export const snapshot = {};

snapshot[`model 1`] = `
[
  Expr {
    raw: {
      else: Expr {
        raw: {
          create_function: Expr {
            raw: {
              object: {
                body: Expr {
                  raw: {
                    query: Expr {
                      raw: {
                        expr: Expr {
                          raw: {
                            in: Expr {
                              raw: {
                                in: Expr {
                                  raw: {
                                    else: Expr {
                                      raw: {
                                        object: {
                                          errors: Expr {
                                            raw: {
                                              collection: Expr {
                                                raw: {
                                                  collection: Expr {
                                                    raw: {
                                                      var: "characters",
                                                    },
                                                  },
                                                  filter: Expr {
                                                    raw: {
                                                      expr: Expr {
                                                        raw: {
                                                          not: Expr {
                                                            raw: {
                                                              is_nonempty: Expr {
                                                                raw: {
                                                                  var: "char",
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                      lambda: "char",
                                                    },
                                                  },
                                                },
                                              },
                                              map: Expr {
                                                raw: {
                                                  expr: Expr {
                                                    raw: {
                                                      from: Expr {
                                                        raw: {
                                                          var: "char",
                                                        },
                                                      },
                                                      select: Expr {
                                                        raw: [
                                                          "@set",
                                                          "terms",
                                                          0,
                                                        ],
                                                      },
                                                    },
                                                  },
                                                  lambda: "char",
                                                },
                                              },
                                            },
                                          },
                                          message: "NOT_FOUND",
                                          ok: false,
                                        },
                                      },
                                    },
                                    if: Expr {
                                      raw: {
                                        all: Expr {
                                          raw: {
                                            collection: Expr {
                                              raw: {
                                                var: "characters",
                                              },
                                            },
                                            map: Expr {
                                              raw: {
                                                expr: Expr {
                                                  raw: {
                                                    is_nonempty: Expr {
                                                      raw: {
                                                        var: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                                lambda: "char",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    then: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            object: {
                                              errors: Expr {
                                                raw: {
                                                  collection: Expr {
                                                    raw: {
                                                      collection: Expr {
                                                        raw: {
                                                          var: "characters",
                                                        },
                                                      },
                                                      filter: Expr {
                                                        raw: {
                                                          expr: Expr {
                                                            raw: {
                                                              not: Expr {
                                                                raw: {
                                                                  equals: Expr {
                                                                    raw: [
                                                                      Expr {
                                                                        raw: {
                                                                          from: Expr {
                                                                            raw: {
                                                                              get: Expr {
                                                                                raw: {
                                                                                  var: "char",
                                                                                },
                                                                              },
                                                                            },
                                                                          },
                                                                          select: Expr {
                                                                            raw: [
                                                                              "data",
                                                                              "user",
                                                                            ],
                                                                          },
                                                                        },
                                                                      },
                                                                      Expr {
                                                                        raw: {
                                                                          from: Expr {
                                                                            raw: {
                                                                              var: "user",
                                                                            },
                                                                          },
                                                                          select: "ref",
                                                                        },
                                                                      },
                                                                    ],
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                          lambda: "char",
                                                        },
                                                      },
                                                    },
                                                  },
                                                  map: Expr {
                                                    raw: {
                                                      expr: Expr {
                                                        raw: {
                                                          from: Expr {
                                                            raw: {
                                                              get: Expr {
                                                                raw: {
                                                                  var: "char",
                                                                },
                                                              },
                                                            },
                                                          },
                                                          select: Expr {
                                                            raw: [
                                                              "data",
                                                              "id",
                                                            ],
                                                          },
                                                        },
                                                      },
                                                      lambda: "char",
                                                    },
                                                  },
                                                },
                                              },
                                              message: "NOT_OWNED",
                                              ok: false,
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            all: Expr {
                                              raw: {
                                                collection: Expr {
                                                  raw: {
                                                    var: "characters",
                                                  },
                                                },
                                                map: Expr {
                                                  raw: {
                                                    expr: Expr {
                                                      raw: {
                                                        equals: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                from: Expr {
                                                                  raw: {
                                                                    get: Expr {
                                                                      raw: {
                                                                        var: "char",
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                                select: Expr {
                                                                  raw: [
                                                                    "data",
                                                                    "user",
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                            Expr {
                                                              raw: {
                                                                from: Expr {
                                                                  raw: {
                                                                    var: "user",
                                                                  },
                                                                },
                                                                select: "ref",
                                                              },
                                                            },
                                                          ],
                                                        },
                                                      },
                                                    },
                                                    lambda: "char",
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            object: {
                                              ok: true,
                                            },
                                          },
                                        },
                                      },
                                    },
                                  },
                                },
                                let: [
                                  {
                                    characters: Expr {
                                      raw: {
                                        collection: Expr {
                                          raw: {
                                            var: "charactersIds",
                                          },
                                        },
                                        map: Expr {
                                          raw: {
                                            expr: Expr {
                                              raw: {
                                                match: Expr {
                                                  raw: {
                                                    index: "characters_instance_id",
                                                  },
                                                },
                                                terms: Expr {
                                                  raw: [
                                                    Expr {
                                                      raw: {
                                                        var: "id",
                                                      },
                                                    },
                                                    Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  ],
                                                },
                                              },
                                            },
                                            lambda: "id",
                                          },
                                        },
                                      },
                                    },
                                  },
                                ],
                              },
                            },
                            let: [
                              {
                                user: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "userId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "userId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                guild: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "guild",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        id: Expr {
                                                          raw: {
                                                            var: "guildId",
                                                          },
                                                        },
                                                        instances: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "guilds_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "guildId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                instance: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInstance",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInstance: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "instance",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                guild: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "guild",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                inventories: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                main: true,
                                                                packs: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedGuild: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                instances: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInstance",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "guild",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                from: Expr {
                                                  raw: {
                                                    var: "match",
                                                  },
                                                },
                                                select: Expr {
                                                  raw: [
                                                    0,
                                                  ],
                                                },
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            from: Expr {
                                              raw: {
                                                var: "guild",
                                              },
                                            },
                                            select: Expr {
                                              raw: [
                                                "data",
                                                "instances",
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                inventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "user",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "user",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "user",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "user",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                            ],
                          },
                        },
                        lambda: Expr {
                          raw: [
                            "charactersIds",
                            "guildId",
                            "userId",
                          ],
                        },
                      },
                    },
                  },
                },
                name: "verify_characters",
              },
            },
          },
        },
      },
      if: Expr {
        raw: {
          exists: Expr {
            raw: {
              function: "verify_characters",
            },
          },
        },
      },
      then: Expr {
        raw: {
          params: Expr {
            raw: {
              object: {
                body: Expr {
                  raw: {
                    query: Expr {
                      raw: {
                        expr: Expr {
                          raw: {
                            in: Expr {
                              raw: {
                                in: Expr {
                                  raw: {
                                    else: Expr {
                                      raw: {
                                        object: {
                                          errors: Expr {
                                            raw: {
                                              collection: Expr {
                                                raw: {
                                                  collection: Expr {
                                                    raw: {
                                                      var: "characters",
                                                    },
                                                  },
                                                  filter: Expr {
                                                    raw: {
                                                      expr: Expr {
                                                        raw: {
                                                          not: Expr {
                                                            raw: {
                                                              is_nonempty: Expr {
                                                                raw: {
                                                                  var: "char",
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                      lambda: "char",
                                                    },
                                                  },
                                                },
                                              },
                                              map: Expr {
                                                raw: {
                                                  expr: Expr {
                                                    raw: {
                                                      from: Expr {
                                                        raw: {
                                                          var: "char",
                                                        },
                                                      },
                                                      select: Expr {
                                                        raw: [
                                                          "@set",
                                                          "terms",
                                                          0,
                                                        ],
                                                      },
                                                    },
                                                  },
                                                  lambda: "char",
                                                },
                                              },
                                            },
                                          },
                                          message: "NOT_FOUND",
                                          ok: false,
                                        },
                                      },
                                    },
                                    if: Expr {
                                      raw: {
                                        all: Expr {
                                          raw: {
                                            collection: Expr {
                                              raw: {
                                                var: "characters",
                                              },
                                            },
                                            map: Expr {
                                              raw: {
                                                expr: Expr {
                                                  raw: {
                                                    is_nonempty: Expr {
                                                      raw: {
                                                        var: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                                lambda: "char",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    then: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            object: {
                                              errors: Expr {
                                                raw: {
                                                  collection: Expr {
                                                    raw: {
                                                      collection: Expr {
                                                        raw: {
                                                          var: "characters",
                                                        },
                                                      },
                                                      filter: Expr {
                                                        raw: {
                                                          expr: Expr {
                                                            raw: {
                                                              not: Expr {
                                                                raw: {
                                                                  equals: Expr {
                                                                    raw: [
                                                                      Expr {
                                                                        raw: {
                                                                          from: Expr {
                                                                            raw: {
                                                                              get: Expr {
                                                                                raw: {
                                                                                  var: "char",
                                                                                },
                                                                              },
                                                                            },
                                                                          },
                                                                          select: Expr {
                                                                            raw: [
                                                                              "data",
                                                                              "user",
                                                                            ],
                                                                          },
                                                                        },
                                                                      },
                                                                      Expr {
                                                                        raw: {
                                                                          from: Expr {
                                                                            raw: {
                                                                              var: "user",
                                                                            },
                                                                          },
                                                                          select: "ref",
                                                                        },
                                                                      },
                                                                    ],
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                          lambda: "char",
                                                        },
                                                      },
                                                    },
                                                  },
                                                  map: Expr {
                                                    raw: {
                                                      expr: Expr {
                                                        raw: {
                                                          from: Expr {
                                                            raw: {
                                                              get: Expr {
                                                                raw: {
                                                                  var: "char",
                                                                },
                                                              },
                                                            },
                                                          },
                                                          select: Expr {
                                                            raw: [
                                                              "data",
                                                              "id",
                                                            ],
                                                          },
                                                        },
                                                      },
                                                      lambda: "char",
                                                    },
                                                  },
                                                },
                                              },
                                              message: "NOT_OWNED",
                                              ok: false,
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            all: Expr {
                                              raw: {
                                                collection: Expr {
                                                  raw: {
                                                    var: "characters",
                                                  },
                                                },
                                                map: Expr {
                                                  raw: {
                                                    expr: Expr {
                                                      raw: {
                                                        equals: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                from: Expr {
                                                                  raw: {
                                                                    get: Expr {
                                                                      raw: {
                                                                        var: "char",
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                                select: Expr {
                                                                  raw: [
                                                                    "data",
                                                                    "user",
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                            Expr {
                                                              raw: {
                                                                from: Expr {
                                                                  raw: {
                                                                    var: "user",
                                                                  },
                                                                },
                                                                select: "ref",
                                                              },
                                                            },
                                                          ],
                                                        },
                                                      },
                                                    },
                                                    lambda: "char",
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            object: {
                                              ok: true,
                                            },
                                          },
                                        },
                                      },
                                    },
                                  },
                                },
                                let: [
                                  {
                                    characters: Expr {
                                      raw: {
                                        collection: Expr {
                                          raw: {
                                            var: "charactersIds",
                                          },
                                        },
                                        map: Expr {
                                          raw: {
                                            expr: Expr {
                                              raw: {
                                                match: Expr {
                                                  raw: {
                                                    index: "characters_instance_id",
                                                  },
                                                },
                                                terms: Expr {
                                                  raw: [
                                                    Expr {
                                                      raw: {
                                                        var: "id",
                                                      },
                                                    },
                                                    Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  ],
                                                },
                                              },
                                            },
                                            lambda: "id",
                                          },
                                        },
                                      },
                                    },
                                  },
                                ],
                              },
                            },
                            let: [
                              {
                                user: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "userId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "userId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                guild: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "guild",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        id: Expr {
                                                          raw: {
                                                            var: "guildId",
                                                          },
                                                        },
                                                        instances: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "guilds_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "guildId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                instance: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInstance",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInstance: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "instance",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                guild: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "guild",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                inventories: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                main: true,
                                                                packs: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedGuild: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                instances: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInstance",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "guild",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                from: Expr {
                                                  raw: {
                                                    var: "match",
                                                  },
                                                },
                                                select: Expr {
                                                  raw: [
                                                    0,
                                                  ],
                                                },
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            from: Expr {
                                              raw: {
                                                var: "guild",
                                              },
                                            },
                                            select: Expr {
                                              raw: [
                                                "data",
                                                "instances",
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                inventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "user",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "user",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "user",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "user",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                            ],
                          },
                        },
                        lambda: Expr {
                          raw: [
                            "charactersIds",
                            "guildId",
                            "userId",
                          ],
                        },
                      },
                    },
                  },
                },
                name: "verify_characters",
              },
            },
          },
          update: Expr {
            raw: {
              function: "verify_characters",
            },
          },
        },
      },
    },
  },
]
`;

snapshot[`model 2`] = `
[
  Expr {
    raw: {
      else: Expr {
        raw: {
          create_function: Expr {
            raw: {
              object: {
                body: Expr {
                  raw: {
                    query: Expr {
                      raw: {
                        expr: Expr {
                          raw: {
                            in: Expr {
                              raw: {
                                in: Expr {
                                  raw: {
                                    else: Expr {
                                      raw: {
                                        object: {
                                          error: "CHARACTER_NOT_FOUND",
                                          ok: false,
                                        },
                                      },
                                    },
                                    if: Expr {
                                      raw: {
                                        all: Expr {
                                          raw: {
                                            collection: Expr {
                                              raw: {
                                                var: "giveCharacters",
                                              },
                                            },
                                            map: Expr {
                                              raw: {
                                                expr: Expr {
                                                  raw: {
                                                    is_nonempty: Expr {
                                                      raw: {
                                                        var: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                                lambda: "char",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    then: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            object: {
                                              error: "CHARACTER_NOT_OWNED",
                                              ok: false,
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            all: Expr {
                                              raw: {
                                                collection: Expr {
                                                  raw: {
                                                    var: "giveCharacters",
                                                  },
                                                },
                                                map: Expr {
                                                  raw: {
                                                    expr: Expr {
                                                      raw: {
                                                        equals: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                from: Expr {
                                                                  raw: {
                                                                    get: Expr {
                                                                      raw: {
                                                                        var: "char",
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                                select: Expr {
                                                                  raw: [
                                                                    "data",
                                                                    "user",
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                            Expr {
                                                              raw: {
                                                                from: Expr {
                                                                  raw: {
                                                                    var: "user",
                                                                  },
                                                                },
                                                                select: "ref",
                                                              },
                                                            },
                                                          ],
                                                        },
                                                      },
                                                    },
                                                    lambda: "char",
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                object: {
                                                  ok: true,
                                                },
                                              },
                                            },
                                            let: [
                                              {
                                                giveCharactersRefs: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            from: Expr {
                                                              raw: {
                                                                get: Expr {
                                                                  raw: {
                                                                    var: "char",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            select: "ref",
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInventory: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                characters: Expr {
                                                                  raw: {
                                                                    difference: Expr {
                                                                      raw: [
                                                                        Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "inventory",
                                                                              },
                                                                            },
                                                                            select: Expr {
                                                                              raw: [
                                                                                "data",
                                                                                "characters",
                                                                              ],
                                                                            },
                                                                          },
                                                                        },
                                                                        Expr {
                                                                          raw: {
                                                                            var: "giveCharactersRefs",
                                                                          },
                                                                        },
                                                                      ],
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "inventory",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedTargetInventory: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                characters: Expr {
                                                                  raw: {
                                                                    union: Expr {
                                                                      raw: [
                                                                        Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "targetInventory",
                                                                              },
                                                                            },
                                                                            select: Expr {
                                                                              raw: [
                                                                                "data",
                                                                                "characters",
                                                                              ],
                                                                            },
                                                                          },
                                                                        },
                                                                        Expr {
                                                                          raw: {
                                                                            var: "giveCharactersRefs",
                                                                          },
                                                                        },
                                                                      ],
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "targetInventory",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedCharacters: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharactersRefs",
                                                      },
                                                    },
                                                    foreach: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            params: Expr {
                                                              raw: {
                                                                object: {
                                                                  data: Expr {
                                                                    raw: {
                                                                      object: {
                                                                        history: Expr {
                                                                          raw: {
                                                                            append: Expr {
                                                                              raw: {
                                                                                object: {
                                                                                  from: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "user",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                  to: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "target",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                },
                                                                              },
                                                                            },
                                                                            collection: Expr {
                                                                              raw: {
                                                                                from: Expr {
                                                                                  raw: {
                                                                                    get: Expr {
                                                                                      raw: {
                                                                                        var: "characterRef",
                                                                                      },
                                                                                    },
                                                                                  },
                                                                                },
                                                                                select: Expr {
                                                                                  raw: [
                                                                                    "data",
                                                                                    "history",
                                                                                  ],
                                                                                },
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        inventory: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "targetInventory",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                        user: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "target",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            update: Expr {
                                                              raw: {
                                                                var: "characterRef",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "characterRef",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                      },
                                    },
                                  },
                                },
                                let: [
                                  {
                                    giveCharacters: Expr {
                                      raw: {
                                        collection: Expr {
                                          raw: {
                                            var: "charactersIds",
                                          },
                                        },
                                        map: Expr {
                                          raw: {
                                            expr: Expr {
                                              raw: {
                                                match: Expr {
                                                  raw: {
                                                    index: "characters_instance_id",
                                                  },
                                                },
                                                terms: Expr {
                                                  raw: [
                                                    Expr {
                                                      raw: {
                                                        var: "id",
                                                      },
                                                    },
                                                    Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  ],
                                                },
                                              },
                                            },
                                            lambda: "id",
                                          },
                                        },
                                      },
                                    },
                                  },
                                ],
                              },
                            },
                            let: [
                              {
                                user: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "userId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "userId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                target: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "targetId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "targetId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                guild: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "guild",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        id: Expr {
                                                          raw: {
                                                            var: "guildId",
                                                          },
                                                        },
                                                        instances: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "guilds_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "guildId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                instance: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInstance",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInstance: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "instance",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                guild: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "guild",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                inventories: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                main: true,
                                                                packs: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedGuild: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                instances: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInstance",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "guild",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                from: Expr {
                                                  raw: {
                                                    var: "match",
                                                  },
                                                },
                                                select: Expr {
                                                  raw: [
                                                    0,
                                                  ],
                                                },
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            from: Expr {
                                              raw: {
                                                var: "guild",
                                              },
                                            },
                                            select: Expr {
                                              raw: [
                                                "data",
                                                "instances",
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                inventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "user",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "user",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "user",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "user",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                targetInventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "target",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "target",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "target",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "target",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                            ],
                          },
                        },
                        lambda: Expr {
                          raw: [
                            "userId",
                            "targetId",
                            "guildId",
                            "charactersIds",
                          ],
                        },
                      },
                    },
                  },
                },
                name: "give_characters",
              },
            },
          },
        },
      },
      if: Expr {
        raw: {
          exists: Expr {
            raw: {
              function: "give_characters",
            },
          },
        },
      },
      then: Expr {
        raw: {
          params: Expr {
            raw: {
              object: {
                body: Expr {
                  raw: {
                    query: Expr {
                      raw: {
                        expr: Expr {
                          raw: {
                            in: Expr {
                              raw: {
                                in: Expr {
                                  raw: {
                                    else: Expr {
                                      raw: {
                                        object: {
                                          error: "CHARACTER_NOT_FOUND",
                                          ok: false,
                                        },
                                      },
                                    },
                                    if: Expr {
                                      raw: {
                                        all: Expr {
                                          raw: {
                                            collection: Expr {
                                              raw: {
                                                var: "giveCharacters",
                                              },
                                            },
                                            map: Expr {
                                              raw: {
                                                expr: Expr {
                                                  raw: {
                                                    is_nonempty: Expr {
                                                      raw: {
                                                        var: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                                lambda: "char",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    then: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            object: {
                                              error: "CHARACTER_NOT_OWNED",
                                              ok: false,
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            all: Expr {
                                              raw: {
                                                collection: Expr {
                                                  raw: {
                                                    var: "giveCharacters",
                                                  },
                                                },
                                                map: Expr {
                                                  raw: {
                                                    expr: Expr {
                                                      raw: {
                                                        equals: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                from: Expr {
                                                                  raw: {
                                                                    get: Expr {
                                                                      raw: {
                                                                        var: "char",
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                                select: Expr {
                                                                  raw: [
                                                                    "data",
                                                                    "user",
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                            Expr {
                                                              raw: {
                                                                from: Expr {
                                                                  raw: {
                                                                    var: "user",
                                                                  },
                                                                },
                                                                select: "ref",
                                                              },
                                                            },
                                                          ],
                                                        },
                                                      },
                                                    },
                                                    lambda: "char",
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                object: {
                                                  ok: true,
                                                },
                                              },
                                            },
                                            let: [
                                              {
                                                giveCharactersRefs: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            from: Expr {
                                                              raw: {
                                                                get: Expr {
                                                                  raw: {
                                                                    var: "char",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            select: "ref",
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInventory: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                characters: Expr {
                                                                  raw: {
                                                                    difference: Expr {
                                                                      raw: [
                                                                        Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "inventory",
                                                                              },
                                                                            },
                                                                            select: Expr {
                                                                              raw: [
                                                                                "data",
                                                                                "characters",
                                                                              ],
                                                                            },
                                                                          },
                                                                        },
                                                                        Expr {
                                                                          raw: {
                                                                            var: "giveCharactersRefs",
                                                                          },
                                                                        },
                                                                      ],
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "inventory",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedTargetInventory: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                characters: Expr {
                                                                  raw: {
                                                                    union: Expr {
                                                                      raw: [
                                                                        Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "targetInventory",
                                                                              },
                                                                            },
                                                                            select: Expr {
                                                                              raw: [
                                                                                "data",
                                                                                "characters",
                                                                              ],
                                                                            },
                                                                          },
                                                                        },
                                                                        Expr {
                                                                          raw: {
                                                                            var: "giveCharactersRefs",
                                                                          },
                                                                        },
                                                                      ],
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "targetInventory",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedCharacters: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharactersRefs",
                                                      },
                                                    },
                                                    foreach: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            params: Expr {
                                                              raw: {
                                                                object: {
                                                                  data: Expr {
                                                                    raw: {
                                                                      object: {
                                                                        history: Expr {
                                                                          raw: {
                                                                            append: Expr {
                                                                              raw: {
                                                                                object: {
                                                                                  from: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "user",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                  to: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "target",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                },
                                                                              },
                                                                            },
                                                                            collection: Expr {
                                                                              raw: {
                                                                                from: Expr {
                                                                                  raw: {
                                                                                    get: Expr {
                                                                                      raw: {
                                                                                        var: "characterRef",
                                                                                      },
                                                                                    },
                                                                                  },
                                                                                },
                                                                                select: Expr {
                                                                                  raw: [
                                                                                    "data",
                                                                                    "history",
                                                                                  ],
                                                                                },
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        inventory: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "targetInventory",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                        user: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "target",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            update: Expr {
                                                              raw: {
                                                                var: "characterRef",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "characterRef",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                      },
                                    },
                                  },
                                },
                                let: [
                                  {
                                    giveCharacters: Expr {
                                      raw: {
                                        collection: Expr {
                                          raw: {
                                            var: "charactersIds",
                                          },
                                        },
                                        map: Expr {
                                          raw: {
                                            expr: Expr {
                                              raw: {
                                                match: Expr {
                                                  raw: {
                                                    index: "characters_instance_id",
                                                  },
                                                },
                                                terms: Expr {
                                                  raw: [
                                                    Expr {
                                                      raw: {
                                                        var: "id",
                                                      },
                                                    },
                                                    Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  ],
                                                },
                                              },
                                            },
                                            lambda: "id",
                                          },
                                        },
                                      },
                                    },
                                  },
                                ],
                              },
                            },
                            let: [
                              {
                                user: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "userId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "userId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                target: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "targetId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "targetId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                guild: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "guild",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        id: Expr {
                                                          raw: {
                                                            var: "guildId",
                                                          },
                                                        },
                                                        instances: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "guilds_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "guildId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                instance: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInstance",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInstance: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "instance",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                guild: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "guild",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                inventories: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                main: true,
                                                                packs: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedGuild: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                instances: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInstance",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "guild",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                from: Expr {
                                                  raw: {
                                                    var: "match",
                                                  },
                                                },
                                                select: Expr {
                                                  raw: [
                                                    0,
                                                  ],
                                                },
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            from: Expr {
                                              raw: {
                                                var: "guild",
                                              },
                                            },
                                            select: Expr {
                                              raw: [
                                                "data",
                                                "instances",
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                inventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "user",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "user",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "user",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "user",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                targetInventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "target",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "target",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "target",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "target",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                            ],
                          },
                        },
                        lambda: Expr {
                          raw: [
                            "userId",
                            "targetId",
                            "guildId",
                            "charactersIds",
                          ],
                        },
                      },
                    },
                  },
                },
                name: "give_characters",
              },
            },
          },
          update: Expr {
            raw: {
              function: "give_characters",
            },
          },
        },
      },
    },
  },
]
`;

snapshot[`model 3`] = `
[
  Expr {
    raw: {
      else: Expr {
        raw: {
          create_function: Expr {
            raw: {
              object: {
                body: Expr {
                  raw: {
                    query: Expr {
                      raw: {
                        expr: Expr {
                          raw: {
                            in: Expr {
                              raw: {
                                in: Expr {
                                  raw: {
                                    else: Expr {
                                      raw: {
                                        object: {
                                          error: "CHARACTER_NOT_FOUND",
                                          ok: false,
                                        },
                                      },
                                    },
                                    if: Expr {
                                      raw: {
                                        and: Expr {
                                          raw: [
                                            Expr {
                                              raw: {
                                                all: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            is_nonempty: Expr {
                                                              raw: {
                                                                var: "char",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                            Expr {
                                              raw: {
                                                all: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "takeCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            is_nonempty: Expr {
                                                              raw: {
                                                                var: "char",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          ],
                                        },
                                      },
                                    },
                                    then: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            object: {
                                              error: "CHARACTER_NOT_OWNED",
                                              ok: false,
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            and: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    all: Expr {
                                                      raw: {
                                                        collection: Expr {
                                                          raw: {
                                                            var: "giveCharacters",
                                                          },
                                                        },
                                                        map: Expr {
                                                          raw: {
                                                            expr: Expr {
                                                              raw: {
                                                                equals: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            get: Expr {
                                                                              raw: {
                                                                                var: "char",
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "user",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "user",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                            lambda: "char",
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    all: Expr {
                                                      raw: {
                                                        collection: Expr {
                                                          raw: {
                                                            var: "takeCharacters",
                                                          },
                                                        },
                                                        map: Expr {
                                                          raw: {
                                                            expr: Expr {
                                                              raw: {
                                                                equals: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            get: Expr {
                                                                              raw: {
                                                                                var: "char",
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "user",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "target",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                            lambda: "char",
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                object: {
                                                  ok: true,
                                                },
                                              },
                                            },
                                            let: [
                                              {
                                                giveCharactersRefs: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            from: Expr {
                                                              raw: {
                                                                get: Expr {
                                                                  raw: {
                                                                    var: "char",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            select: "ref",
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                takeCharactersRefs: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "takeCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            from: Expr {
                                                              raw: {
                                                                get: Expr {
                                                                  raw: {
                                                                    var: "char",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            select: "ref",
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInventory: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                characters: Expr {
                                                                  raw: {
                                                                    union: Expr {
                                                                      raw: [
                                                                        Expr {
                                                                          raw: {
                                                                            var: "takeCharactersRefs",
                                                                          },
                                                                        },
                                                                        Expr {
                                                                          raw: {
                                                                            difference: Expr {
                                                                              raw: [
                                                                                Expr {
                                                                                  raw: {
                                                                                    from: Expr {
                                                                                      raw: {
                                                                                        var: "inventory",
                                                                                      },
                                                                                    },
                                                                                    select: Expr {
                                                                                      raw: [
                                                                                        "data",
                                                                                        "characters",
                                                                                      ],
                                                                                    },
                                                                                  },
                                                                                },
                                                                                Expr {
                                                                                  raw: {
                                                                                    var: "giveCharactersRefs",
                                                                                  },
                                                                                },
                                                                              ],
                                                                            },
                                                                          },
                                                                        },
                                                                      ],
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "inventory",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedTargetInventory: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                characters: Expr {
                                                                  raw: {
                                                                    union: Expr {
                                                                      raw: [
                                                                        Expr {
                                                                          raw: {
                                                                            var: "giveCharactersRefs",
                                                                          },
                                                                        },
                                                                        Expr {
                                                                          raw: {
                                                                            difference: Expr {
                                                                              raw: [
                                                                                Expr {
                                                                                  raw: {
                                                                                    from: Expr {
                                                                                      raw: {
                                                                                        var: "inventory",
                                                                                      },
                                                                                    },
                                                                                    select: Expr {
                                                                                      raw: [
                                                                                        "data",
                                                                                        "characters",
                                                                                      ],
                                                                                    },
                                                                                  },
                                                                                },
                                                                                Expr {
                                                                                  raw: {
                                                                                    var: "takeCharactersRefs",
                                                                                  },
                                                                                },
                                                                              ],
                                                                            },
                                                                          },
                                                                        },
                                                                      ],
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "targetInventory",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedCharacters: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharactersRefs",
                                                      },
                                                    },
                                                    foreach: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            params: Expr {
                                                              raw: {
                                                                object: {
                                                                  data: Expr {
                                                                    raw: {
                                                                      object: {
                                                                        history: Expr {
                                                                          raw: {
                                                                            append: Expr {
                                                                              raw: {
                                                                                object: {
                                                                                  from: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "user",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                  to: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "target",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                },
                                                                              },
                                                                            },
                                                                            collection: Expr {
                                                                              raw: {
                                                                                from: Expr {
                                                                                  raw: {
                                                                                    get: Expr {
                                                                                      raw: {
                                                                                        var: "characterRef",
                                                                                      },
                                                                                    },
                                                                                  },
                                                                                },
                                                                                select: Expr {
                                                                                  raw: [
                                                                                    "data",
                                                                                    "history",
                                                                                  ],
                                                                                },
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        inventory: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "targetInventory",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                        user: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "target",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            update: Expr {
                                                              raw: {
                                                                var: "characterRef",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "characterRef",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedTakeCharacters: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "takeCharactersRefs",
                                                      },
                                                    },
                                                    foreach: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            params: Expr {
                                                              raw: {
                                                                object: {
                                                                  data: Expr {
                                                                    raw: {
                                                                      object: {
                                                                        history: Expr {
                                                                          raw: {
                                                                            append: Expr {
                                                                              raw: {
                                                                                object: {
                                                                                  from: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "target",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                  to: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "user",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                },
                                                                              },
                                                                            },
                                                                            collection: Expr {
                                                                              raw: {
                                                                                from: Expr {
                                                                                  raw: {
                                                                                    get: Expr {
                                                                                      raw: {
                                                                                        var: "characterRef",
                                                                                      },
                                                                                    },
                                                                                  },
                                                                                },
                                                                                select: Expr {
                                                                                  raw: [
                                                                                    "data",
                                                                                    "history",
                                                                                  ],
                                                                                },
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        inventory: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "inventory",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                        user: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "user",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            update: Expr {
                                                              raw: {
                                                                var: "characterRef",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "characterRef",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                      },
                                    },
                                  },
                                },
                                let: [
                                  {
                                    giveCharacters: Expr {
                                      raw: {
                                        collection: Expr {
                                          raw: {
                                            var: "giveCharactersIds",
                                          },
                                        },
                                        map: Expr {
                                          raw: {
                                            expr: Expr {
                                              raw: {
                                                match: Expr {
                                                  raw: {
                                                    index: "characters_instance_id",
                                                  },
                                                },
                                                terms: Expr {
                                                  raw: [
                                                    Expr {
                                                      raw: {
                                                        var: "id",
                                                      },
                                                    },
                                                    Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  ],
                                                },
                                              },
                                            },
                                            lambda: "id",
                                          },
                                        },
                                      },
                                    },
                                  },
                                  {
                                    takeCharacters: Expr {
                                      raw: {
                                        collection: Expr {
                                          raw: {
                                            var: "takeCharactersIds",
                                          },
                                        },
                                        map: Expr {
                                          raw: {
                                            expr: Expr {
                                              raw: {
                                                match: Expr {
                                                  raw: {
                                                    index: "characters_instance_id",
                                                  },
                                                },
                                                terms: Expr {
                                                  raw: [
                                                    Expr {
                                                      raw: {
                                                        var: "id",
                                                      },
                                                    },
                                                    Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  ],
                                                },
                                              },
                                            },
                                            lambda: "id",
                                          },
                                        },
                                      },
                                    },
                                  },
                                ],
                              },
                            },
                            let: [
                              {
                                user: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "userId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "userId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                target: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "targetId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "targetId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                guild: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "guild",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        id: Expr {
                                                          raw: {
                                                            var: "guildId",
                                                          },
                                                        },
                                                        instances: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "guilds_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "guildId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                instance: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInstance",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInstance: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "instance",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                guild: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "guild",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                inventories: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                main: true,
                                                                packs: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedGuild: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                instances: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInstance",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "guild",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                from: Expr {
                                                  raw: {
                                                    var: "match",
                                                  },
                                                },
                                                select: Expr {
                                                  raw: [
                                                    0,
                                                  ],
                                                },
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            from: Expr {
                                              raw: {
                                                var: "guild",
                                              },
                                            },
                                            select: Expr {
                                              raw: [
                                                "data",
                                                "instances",
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                inventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "user",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "user",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "user",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "user",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                targetInventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "target",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "target",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "target",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "target",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                            ],
                          },
                        },
                        lambda: Expr {
                          raw: [
                            "userId",
                            "targetId",
                            "guildId",
                            "giveCharactersIds",
                            "takeCharactersIds",
                          ],
                        },
                      },
                    },
                  },
                },
                name: "trade_characters",
              },
            },
          },
        },
      },
      if: Expr {
        raw: {
          exists: Expr {
            raw: {
              function: "trade_characters",
            },
          },
        },
      },
      then: Expr {
        raw: {
          params: Expr {
            raw: {
              object: {
                body: Expr {
                  raw: {
                    query: Expr {
                      raw: {
                        expr: Expr {
                          raw: {
                            in: Expr {
                              raw: {
                                in: Expr {
                                  raw: {
                                    else: Expr {
                                      raw: {
                                        object: {
                                          error: "CHARACTER_NOT_FOUND",
                                          ok: false,
                                        },
                                      },
                                    },
                                    if: Expr {
                                      raw: {
                                        and: Expr {
                                          raw: [
                                            Expr {
                                              raw: {
                                                all: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            is_nonempty: Expr {
                                                              raw: {
                                                                var: "char",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                            Expr {
                                              raw: {
                                                all: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "takeCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            is_nonempty: Expr {
                                                              raw: {
                                                                var: "char",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          ],
                                        },
                                      },
                                    },
                                    then: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            object: {
                                              error: "CHARACTER_NOT_OWNED",
                                              ok: false,
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            and: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    all: Expr {
                                                      raw: {
                                                        collection: Expr {
                                                          raw: {
                                                            var: "giveCharacters",
                                                          },
                                                        },
                                                        map: Expr {
                                                          raw: {
                                                            expr: Expr {
                                                              raw: {
                                                                equals: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            get: Expr {
                                                                              raw: {
                                                                                var: "char",
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "user",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "user",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                            lambda: "char",
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    all: Expr {
                                                      raw: {
                                                        collection: Expr {
                                                          raw: {
                                                            var: "takeCharacters",
                                                          },
                                                        },
                                                        map: Expr {
                                                          raw: {
                                                            expr: Expr {
                                                              raw: {
                                                                equals: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            get: Expr {
                                                                              raw: {
                                                                                var: "char",
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "user",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "target",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                            lambda: "char",
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                object: {
                                                  ok: true,
                                                },
                                              },
                                            },
                                            let: [
                                              {
                                                giveCharactersRefs: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            from: Expr {
                                                              raw: {
                                                                get: Expr {
                                                                  raw: {
                                                                    var: "char",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            select: "ref",
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                takeCharactersRefs: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "takeCharacters",
                                                      },
                                                    },
                                                    map: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            from: Expr {
                                                              raw: {
                                                                get: Expr {
                                                                  raw: {
                                                                    var: "char",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            select: "ref",
                                                          },
                                                        },
                                                        lambda: "char",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInventory: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                characters: Expr {
                                                                  raw: {
                                                                    union: Expr {
                                                                      raw: [
                                                                        Expr {
                                                                          raw: {
                                                                            var: "takeCharactersRefs",
                                                                          },
                                                                        },
                                                                        Expr {
                                                                          raw: {
                                                                            difference: Expr {
                                                                              raw: [
                                                                                Expr {
                                                                                  raw: {
                                                                                    from: Expr {
                                                                                      raw: {
                                                                                        var: "inventory",
                                                                                      },
                                                                                    },
                                                                                    select: Expr {
                                                                                      raw: [
                                                                                        "data",
                                                                                        "characters",
                                                                                      ],
                                                                                    },
                                                                                  },
                                                                                },
                                                                                Expr {
                                                                                  raw: {
                                                                                    var: "giveCharactersRefs",
                                                                                  },
                                                                                },
                                                                              ],
                                                                            },
                                                                          },
                                                                        },
                                                                      ],
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "inventory",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedTargetInventory: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                characters: Expr {
                                                                  raw: {
                                                                    union: Expr {
                                                                      raw: [
                                                                        Expr {
                                                                          raw: {
                                                                            var: "giveCharactersRefs",
                                                                          },
                                                                        },
                                                                        Expr {
                                                                          raw: {
                                                                            difference: Expr {
                                                                              raw: [
                                                                                Expr {
                                                                                  raw: {
                                                                                    from: Expr {
                                                                                      raw: {
                                                                                        var: "inventory",
                                                                                      },
                                                                                    },
                                                                                    select: Expr {
                                                                                      raw: [
                                                                                        "data",
                                                                                        "characters",
                                                                                      ],
                                                                                    },
                                                                                  },
                                                                                },
                                                                                Expr {
                                                                                  raw: {
                                                                                    var: "takeCharactersRefs",
                                                                                  },
                                                                                },
                                                                              ],
                                                                            },
                                                                          },
                                                                        },
                                                                      ],
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "targetInventory",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedCharacters: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "giveCharactersRefs",
                                                      },
                                                    },
                                                    foreach: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            params: Expr {
                                                              raw: {
                                                                object: {
                                                                  data: Expr {
                                                                    raw: {
                                                                      object: {
                                                                        history: Expr {
                                                                          raw: {
                                                                            append: Expr {
                                                                              raw: {
                                                                                object: {
                                                                                  from: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "user",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                  to: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "target",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                },
                                                                              },
                                                                            },
                                                                            collection: Expr {
                                                                              raw: {
                                                                                from: Expr {
                                                                                  raw: {
                                                                                    get: Expr {
                                                                                      raw: {
                                                                                        var: "characterRef",
                                                                                      },
                                                                                    },
                                                                                  },
                                                                                },
                                                                                select: Expr {
                                                                                  raw: [
                                                                                    "data",
                                                                                    "history",
                                                                                  ],
                                                                                },
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        inventory: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "targetInventory",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                        user: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "target",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            update: Expr {
                                                              raw: {
                                                                var: "characterRef",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "characterRef",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedTakeCharacters: Expr {
                                                  raw: {
                                                    collection: Expr {
                                                      raw: {
                                                        var: "takeCharactersRefs",
                                                      },
                                                    },
                                                    foreach: Expr {
                                                      raw: {
                                                        expr: Expr {
                                                          raw: {
                                                            params: Expr {
                                                              raw: {
                                                                object: {
                                                                  data: Expr {
                                                                    raw: {
                                                                      object: {
                                                                        history: Expr {
                                                                          raw: {
                                                                            append: Expr {
                                                                              raw: {
                                                                                object: {
                                                                                  from: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "target",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                  to: Expr {
                                                                                    raw: {
                                                                                      from: Expr {
                                                                                        raw: {
                                                                                          var: "user",
                                                                                        },
                                                                                      },
                                                                                      select: "ref",
                                                                                    },
                                                                                  },
                                                                                },
                                                                              },
                                                                            },
                                                                            collection: Expr {
                                                                              raw: {
                                                                                from: Expr {
                                                                                  raw: {
                                                                                    get: Expr {
                                                                                      raw: {
                                                                                        var: "characterRef",
                                                                                      },
                                                                                    },
                                                                                  },
                                                                                },
                                                                                select: Expr {
                                                                                  raw: [
                                                                                    "data",
                                                                                    "history",
                                                                                  ],
                                                                                },
                                                                              },
                                                                            },
                                                                          },
                                                                        },
                                                                        inventory: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "inventory",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                        user: Expr {
                                                                          raw: {
                                                                            from: Expr {
                                                                              raw: {
                                                                                var: "user",
                                                                              },
                                                                            },
                                                                            select: "ref",
                                                                          },
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                            update: Expr {
                                                              raw: {
                                                                var: "characterRef",
                                                              },
                                                            },
                                                          },
                                                        },
                                                        lambda: "characterRef",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                      },
                                    },
                                  },
                                },
                                let: [
                                  {
                                    giveCharacters: Expr {
                                      raw: {
                                        collection: Expr {
                                          raw: {
                                            var: "giveCharactersIds",
                                          },
                                        },
                                        map: Expr {
                                          raw: {
                                            expr: Expr {
                                              raw: {
                                                match: Expr {
                                                  raw: {
                                                    index: "characters_instance_id",
                                                  },
                                                },
                                                terms: Expr {
                                                  raw: [
                                                    Expr {
                                                      raw: {
                                                        var: "id",
                                                      },
                                                    },
                                                    Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  ],
                                                },
                                              },
                                            },
                                            lambda: "id",
                                          },
                                        },
                                      },
                                    },
                                  },
                                  {
                                    takeCharacters: Expr {
                                      raw: {
                                        collection: Expr {
                                          raw: {
                                            var: "takeCharactersIds",
                                          },
                                        },
                                        map: Expr {
                                          raw: {
                                            expr: Expr {
                                              raw: {
                                                match: Expr {
                                                  raw: {
                                                    index: "characters_instance_id",
                                                  },
                                                },
                                                terms: Expr {
                                                  raw: [
                                                    Expr {
                                                      raw: {
                                                        var: "id",
                                                      },
                                                    },
                                                    Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  ],
                                                },
                                              },
                                            },
                                            lambda: "id",
                                          },
                                        },
                                      },
                                    },
                                  },
                                ],
                              },
                            },
                            let: [
                              {
                                user: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "userId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "userId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                target: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "user",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        badges: Expr {
                                                          raw: [
                                                            Expr {
                                                              raw: {
                                                                id: "357600097731608662",
                                                                ref: Expr {
                                                                  raw: {
                                                                    collection: "badge",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          ],
                                                        },
                                                        id: Expr {
                                                          raw: {
                                                            var: "targetId",
                                                          },
                                                        },
                                                        inventories: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "users_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "targetId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                guild: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            create: Expr {
                                              raw: {
                                                collection: "guild",
                                              },
                                            },
                                            params: Expr {
                                              raw: {
                                                object: {
                                                  data: Expr {
                                                    raw: {
                                                      object: {
                                                        id: Expr {
                                                          raw: {
                                                            var: "guildId",
                                                          },
                                                        },
                                                        instances: Expr {
                                                          raw: [
                                                          ],
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            },
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "guilds_discord_id",
                                              },
                                            },
                                            terms: Expr {
                                              raw: {
                                                var: "guildId",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                instance: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInstance",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInstance: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "instance",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                guild: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "guild",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                inventories: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                main: true,
                                                                packs: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedGuild: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                instances: Expr {
                                                                  raw: [
                                                                    Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInstance",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                  ],
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "guild",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                from: Expr {
                                                  raw: {
                                                    var: "match",
                                                  },
                                                },
                                                select: Expr {
                                                  raw: [
                                                    0,
                                                  ],
                                                },
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            from: Expr {
                                              raw: {
                                                var: "guild",
                                              },
                                            },
                                            select: Expr {
                                              raw: [
                                                "data",
                                                "instances",
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                inventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "user",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "user",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "user",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "user",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                              {
                                targetInventory: Expr {
                                  raw: {
                                    in: Expr {
                                      raw: {
                                        else: Expr {
                                          raw: {
                                            in: Expr {
                                              raw: {
                                                var: "createdInventory",
                                              },
                                            },
                                            let: [
                                              {
                                                createdInventory: Expr {
                                                  raw: {
                                                    create: Expr {
                                                      raw: {
                                                        collection: "inventory",
                                                      },
                                                    },
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                availablePulls: 5,
                                                                characters: Expr {
                                                                  raw: [
                                                                  ],
                                                                },
                                                                instance: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "instance",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                                user: Expr {
                                                                  raw: {
                                                                    from: Expr {
                                                                      raw: {
                                                                        var: "target",
                                                                      },
                                                                    },
                                                                    select: "ref",
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedInstance: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "instance",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "instance",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                              {
                                                updatedUser: Expr {
                                                  raw: {
                                                    params: Expr {
                                                      raw: {
                                                        object: {
                                                          data: Expr {
                                                            raw: {
                                                              object: {
                                                                inventories: Expr {
                                                                  raw: {
                                                                    append: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "createdInventory",
                                                                          },
                                                                        },
                                                                        select: "ref",
                                                                      },
                                                                    },
                                                                    collection: Expr {
                                                                      raw: {
                                                                        from: Expr {
                                                                          raw: {
                                                                            var: "target",
                                                                          },
                                                                        },
                                                                        select: Expr {
                                                                          raw: [
                                                                            "data",
                                                                            "inventories",
                                                                          ],
                                                                        },
                                                                      },
                                                                    },
                                                                  },
                                                                },
                                                              },
                                                            },
                                                          },
                                                        },
                                                      },
                                                    },
                                                    update: Expr {
                                                      raw: {
                                                        from: Expr {
                                                          raw: {
                                                            var: "target",
                                                          },
                                                        },
                                                        select: "ref",
                                                      },
                                                    },
                                                  },
                                                },
                                              },
                                            ],
                                          },
                                        },
                                        if: Expr {
                                          raw: {
                                            is_nonempty: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                        then: Expr {
                                          raw: {
                                            get: Expr {
                                              raw: {
                                                var: "match",
                                              },
                                            },
                                          },
                                        },
                                      },
                                    },
                                    let: [
                                      {
                                        match: Expr {
                                          raw: {
                                            match: Expr {
                                              raw: {
                                                index: "inventories_instance_user",
                                              },
                                            },
                                            terms: Expr {
                                              raw: [
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "instance",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                                Expr {
                                                  raw: {
                                                    from: Expr {
                                                      raw: {
                                                        var: "target",
                                                      },
                                                    },
                                                    select: "ref",
                                                  },
                                                },
                                              ],
                                            },
                                          },
                                        },
                                      },
                                    ],
                                  },
                                },
                              },
                            ],
                          },
                        },
                        lambda: Expr {
                          raw: [
                            "userId",
                            "targetId",
                            "guildId",
                            "giveCharactersIds",
                            "takeCharactersIds",
                          ],
                        },
                      },
                    },
                  },
                },
                name: "trade_characters",
              },
            },
          },
          update: Expr {
            raw: {
              function: "trade_characters",
            },
          },
        },
      },
    },
  },
]
`;
